---
layout: post
title: Redis JWT Refresh Token ê´€ë¦¬ ë° ì¬ë°œí–‰
subtitle: 
categories: DB
tags: [DB, redis]
comments: true
published: true
---

Redisì— ëŒ€í•œ ê°„ë‹¨í•œ CSì§€ì‹ê³¼   
[Redis ì„¤ì¹˜ ë° CLI ì‚¬ìš©ë²•]ì„ ì•Œì•„ë³´ì•˜ì—ˆë‹¤.   

ì˜¤ëŠ˜ì€ ì´ì œ ë‚˜ì˜ ì‚¬ìš© ëª©ì ì¸ í”„ë¡œì íŠ¸ì— ë„ì…ì„ í•´ë³´ë ¤í•œë‹¤.   
JWT Refresh Tokenê´€ë¦¬ì™€ ì¢‹ì•„ìš”,ì¡°íšŒìˆ˜ ë“±   
ë¹ˆë²ˆíˆ updateê°€ ì¼ì–´ë‚˜ëŠ” í•­ëª©ì— ëŒ€í•´ì„œ ê´€ë¦¬í•˜ëŠ” ì°¨ì›ì—ì„œ   
ìºì‹œì„œë²„ì¸ Redisë¥¼ ì‚¬ìš©í•´ë³´ë ¤í•œë‹¤.     

ê·¸ ì¤‘ì—ì„œë„ Redis ì‚¬ìš©ì— ëŒ€í•œ ì½”ë“œì™€  
JWT í† í°ì„ Redisì— ì–´ë–»ê²Œ ê´€ë¦¬í•˜ê³  ì¬ë°œê¸‰ë°›ëŠ”ì§€ì— ëŒ€í•´  
ì´ˆì ì„ ë‘ê³  ì‘ì„±í–ˆê¸°ì— ë§ì€ ì½”ë“œë“¤ì´ ìƒëµë˜ì–´ ìˆë‹¤ëŠ”ì  ì°¸ê³  ë¶€íƒë“œë¦°ë‹¤.


### âœ… ì‘ì—…í™˜ê²½

```text
Spring Boot 2.7.7
java 11 
macOS Ventura 13.1
ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ì§„í–‰
```

<br/>

### ğŸ“Œ Redis í”„ë¡œê·¸ë¨ ì‘ì„±  

Spring Bootì—ì„œëŠ” `Spring Data Redis`ë¥¼ ì´ìš©í•´  
Lettuce, Jedisë¼ëŠ” ë‘ê°€ì§€ ì˜¤í”ˆì†ŒìŠ¤ Java ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.  
LettuceëŠ” ë³„ë„ì˜ ì„¤ì •ì´ í•„ìš”ì—†ê³ , JedisëŠ” ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì¤˜ì•¼í•œë‹¤.   

Gradle ì˜ì¡´ì„±
```java
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
```

Spring data RedisëŠ” ë‘ê°€ì§€ ì ‘ê·¼ ë°©ì‹ì„ ì œê³µí•˜ëŠ”ë°  
í•˜ë‚˜ëŠ” Redis Template, í•˜ë‚˜ëŠ” RedisRepositoryë¥¼ ì´ìš©í•œ ë°©ì‹ì´ë‹¤.     
ì´ë²ˆì— ì‚¬ìš©í•´ë³¸ ë°©ë²•ì€ Redis Template ë°©ì‹ì´ê³ 

`RedisConnectionFactory` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´  
`LettuceConnectionFactory` ìƒì„±í•˜ì—¬ ë°˜í™˜í•˜ëŠ” Beanì„ ë“±ë¡í•´ì•¼í•œë‹¤.
 
**1). RedisConfig í´ë˜ìŠ¤**  

```java
@Configuration
public class RedisConfig {

	@Value("${spring.redis.host}")
	private String host;

	@Value("${spring.redis.port}")
	private int port;

	@Bean
	public RedisConnectionFactory redisConnectionFactory() {
		return new LettuceConnectionFactory(host, port);
	}

	@Bean
	public RedisTemplate<String, Object> redisTemplate() {
		RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
		redisTemplate.setKeySerializer(new StringRedisSerializer());
		redisTemplate.setValueSerializer(new StringRedisSerializer());
		redisTemplate.setConnectionFactory(redisConnectionFactory());
		return redisTemplate;
	}
}
```
`LettuceConnectionFactory`ë¥¼ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ ë°˜í™˜í• ë•Œ  
host, port ì •ë³´ê°€ í•„ìš”í•˜ë‹¤.

```yaml
spring:
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379
```

ë¡œì»¬í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ê²ƒì´ê¸° ë•Œë¬¸ì—  
ymlíŒŒì¼ì— ì„¤ì •í•´ì£¼ê³  @Value ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ íŒŒì‹±í•˜ë„ë¡ í–ˆë‹¤.  

ê·¸ë¦¬ê³  `setKeySerializer`,`setValueSerializer`ì™€ ê°™ì€  
`RedisTemplete`ê°ì²´ì— ì„¤ì •ì„ í•´ì£¼ëŠ” ì´ìœ ëŠ”  

RedisTemplateë¥¼ ì‚¬ìš©í•  ë•Œ Spring - Redis ê°„ ë°ì´í„°  
ì§ë ¬í™”,ì—­ì§ë ¬í™” ì‹œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ JDK ì§ë ¬í™” ë°©ì‹ì´ê¸° ë•Œë¬¸ì—   
ë¬¸ì œëŠ” ì—†ì§€ë§Œ redis-clië¥¼ í†µí•´ ì ‘ê·¼í• ë•Œ ì•Œì•„ë³¼ ìˆ˜ ì—†ëŠ” í˜•íƒœë¡œ ì¶œë ¥ë˜ê¸° ë•Œë¬¸ì—   
ì„¤ì •ì„ ì§„í–‰ í•´ì¤€ ê²ƒì´ë‹¤!  


<br/>

**2). RedisDao í´ë˜ìŠ¤**   

```java
@Component
public class RedisDao {

    private final RedisTemplate<String, Object> redisTemplate;

    public RedisDao(RedisTemplate<String, Object> redisTemplate) {
        this.redisTemplate = redisTemplate;
    }

    public void setValues(String key, String data) {
        ValueOperations<String, Object> values = redisTemplate.opsForValue();
        values.set(key, data);
    }

    public void setValues(String key, String data, Duration duration) {
        ValueOperations<String, Object> values = redisTemplate.opsForValue();
        values.set(key, data, duration);
    }

    public String getValues(String key) {
        ValueOperations<String, Object> values = redisTemplate.opsForValue();
        return (String) values.get(key);
    }

    public void deleteValues(String key) {
        redisTemplate.delete(key);
    }

    public void expireValues(String key, int timeout){
        redisTemplate.expire(key, timeout , TimeUnit.MILLISECONDS);
    }

    public void setHashOps(String key, Map<String,String> data) {
        HashOperations<String, Object, Object> values = redisTemplate.opsForHash();
        values.putAll(key, data);
    }

    public String getHashOps(String key, String hashKey) {
        HashOperations<String, Object, Object> values = redisTemplate.opsForHash();
        return values.hasKey(key, hashKey) ? (String)redisTemplate.opsForHash().get(key, hashKey) : new String();
    }

    public void deleteHashOps(String key, String hashKey) {
        HashOperations<String, Object, Object> values = redisTemplate.opsForHash();
        values.delete(key, hashKey);
    }

    public boolean validateValue(String value){
        if(value == null){
            return false;
        }
        return true;
    }
}
```

ë‘ë²ˆì§¸ë¡œëŠ” `RedisDao`ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´   
ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë¹ˆìœ¼ë¡œ ë“±ë¡í•´  
DI ë°›ì•„ ì‚¬ìš©í•˜ë„ë¡ í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ ì£¼ì—ˆë‹¤.   

ì•ˆì— ë©”ì„œë“œ ë‚´ìš©ë“¤ì„ ë³´ë©´   
ê¸°ë³¸ì ì¸ Key,Valueë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•, ê·¸ë¦¬ê³  Getí•˜ì—¬ ê°€ì ¸ì˜¤ê¸°   
ë˜í•œ ì†Œë©¸ ì‹œê°„ì„¤ì •(TTL)ì„ í•˜ì—¬ Keyë¥¼ ë§Œë“¤ê¸°   

Hash ìë£Œêµ¬ì¡°ë¡œ Key,Value ë§Œë“¤ê¸° ì •ë„ ì½”ë“œë¥¼ ì¶”ê°€í•´ë‘ì—ˆë‹¤.   
JWTì‚¬ìš©í• ë• ê¸°ë³¸ì  Key,Valueë¡œ ì§„í–‰í•  ì˜ˆì •ì´ê³   
ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ Hash êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê¸°ë•Œë¬¸ì— ìš°ì„  ì¶”ê°€í•´ì¤¬ë‹¤.

<br/>  

### ğŸ“Œ Redisë¥¼ í†µí•œ Refresh Token ê´€ë¦¬   

#### Redisë¥¼ ì´ìš©í•œ JWT í™œìš©

ì´ëŸ¬í•œ ë°©ë²•ì´ ì •ë§ ìµœì„ ì¼ì§€?   
í™•ì‹¤í•˜ì§„ ì•Šë‹¤... ì—¬ëŸ¬ê°€ì§€ ë ˆí¼ëŸ°ìŠ¤ ë¸”ë¡œê·¸ë“¤ì„ ë³´ë©´ì„œ  
ì´ë²ˆì— í”„ë¡œì íŠ¸ë¥¼ í•˜ë©´ì„œ ì ìš©í•´ë³¸ ì•„í‚¤í…ì²˜ë¥¼ ê·¸ë ¤ë³´ì•˜ë‹¤.

![image](https://user-images.githubusercontent.com/95069395/212480772-df9dcb0d-241e-4301-97e7-688b64424717.png){: .align-left style="max-width: 100%"}

ìˆœì„œë¥¼ ì‚´í´ ë³´ìë©´   

**1). ë¡œê·¸ì¸ì‹œ JWT í† í°ì„ ë°œê¸‰ ë°›ëŠ”ë‹¤.**  
-> AccessToken, RefreshTokenì„ ë°œê¸‰ ë°›ìŒ.

<br/>

**2). ë°œê¸‰ë°›ì€ í† í°ì„ Clientì— ì „ë‹¬ í•œë‹¤.**  
-> Access Tokenì€ Headerì— `Authorization`ì— ë‹´ëŠ”ë‹¤.  
-> Refresh Tokenì€ ì¿ í‚¤ì— ë‹´ì•„ ë³´ë‚´ì¤€ë‹¤.
ì „ë‹¬í•˜ê¸° ì „ì— ì„œë²„ì—ì„œëŠ” Refresh Tokenì„ Redis ìºì‹œì„œë²„ì— Key/Value   
í˜•íƒœë¡œ ì†Œë©¸ì‹œê°„ì„ ì§€ì •í•´ ì €ì¥í•œë‹¤. (ë‚˜ëŠ” 2ì¼ ì •ë„ë¡œ í•´ë‘ì—ˆë‹¤)

â—ï¸**ìƒê°í•´ë³¼ ë§Œí•œ ë‚´ìš©ë“¤**  
ì—¬ê¸°ì„œ ìƒê°í•´ë³´ë©´ ì¢‹ì€ ì ì´. Refresh Tokenì„ í´ë¼ì´ì–¸íŠ¸ì— ë³´ë‚´ëŠ” ê²ƒì´  
ì •ë§ ìµœì‹ ì¸ê°€? ë¼ëŠ” ìƒê°ì´ ë“ ë‹¤. ì´ë¶€ë¶„ì— ëŒ€í•´ ê³ ë¯¼ì„ ë§ì´í•´ë´¤ê³  ë§ì´ ì°¾ì•„ë³´ì•˜ì§€ë§Œ  
ê²°ë¡ ì ìœ¼ë¡œ ë‚´ê°€ ë‚´ë¦° ìƒê°ì€ í•´ë‹¹ Refresh Tokenì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ  
ë³´ë‚´ì£¼ì§€ ì•Šìœ¼ë©´ Access Tokenìœ¼ë¡œë§Œ ì¬ë°œê¸‰ì´ ì´ë£¨ì–´ì§€ê²Œë˜ëŠ”ë°  
Access Tokenì„ íƒˆì·¨ë‹¹í•  ê²½ìš° Redisì— ìˆëŠ” Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰ì´ ê°€ëŠ¥í•´ì§€ë‹ˆ  
ìœ„í—˜í•´ ì§ˆ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì— ì´ë¥´ëŸ¿ê³ , ì·¨ì•½ì ì´ ì¡´ì¬í•˜ì§€ë§Œ ìµœì†Œí•œ ì¿ í‚¤ë¡œ ë‹´ì•„ ë³´ë‚´   
HttpOnly ì˜µì…˜ìœ¼ë¡œ XSS(Cross-Site Scripting) ê³µê²©ì„ ë§‰ì„ ìˆ˜ê¸°ì— ë³´ë‚´ì£¼ê¸°ë¡œ ê²°ì •í–ˆë‹¤.  

<br/>

**3). API ìš”ì²­í• ë•Œ ì¸ì¦ì„ ìœ„í•œ Access Tokenì„ ë‹´ì•„ ìš”ì²­í•œë‹¤.**  
-> ì •ìƒì ìœ¼ë¡œ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ í•´ë‹¹ APIë¥¼ ìˆ˜í–‰í•œë‹¤.  
-> ë§Œì•½ Access Tokenì´ ë§Œë£Œë˜ì—ˆë‹¤ë©´? ì„œë²„ì—ì„œëŠ” ë§Œë£Œë˜ì—ˆë‹¤ê³    
í´ë¼ì´ì–¸íŠ¸ì¸¡ì— ì•Œë ¤ì¤€ë‹¤. (ë‚˜ì™€ ê°™ì€ê²½ìš°ëŠ” í† í°ì´ ë§Œë£Œë˜ì—ˆë‹¤ê³  JSONì„ ì‘ë‹µí•´ì¤Œ)  

<br/>

**4). ë§Œë£Œì‘ë‹µì„ ë°›ì€ í´ë¼ì´ì–¸íŠ¸ëŠ” Access Token ì¬ë°œí–‰ APIë¥¼ ìš”ì²­í•œë‹¤.**  
-> Access Tokenê³¼ Refresh Tokenì„ í—¤ë”ì— ë‹´ì•„ì„œ Access Token ì¬ë°œê¸‰ì„ ìš”ì²­í•œë‹¤.  
-> ì¬ë°œê¸‰ ìš”ì²­ì„ ë°›ì€ ì„œë²„ëŠ” Refresh Tokenì„ Redisì—ì„œ ì°¾ëŠ”ë‹¤.   
-> ë§Œì•½ Redis ìºì‹œì„œë²„ì•ˆì— Refresh Tokenì´ ì†Œë©¸ë˜ì§€ ì•Šì•˜ë‹¤ë©´  
Access Token ì¬ë°œê¸‰ ì‹œí€€ìŠ¤ë¥¼ ì§„í–‰í•œë‹¤.  
-> ë§Œì•½ Refresh Tokenì´ ì†Œë©¸ë˜ì—ˆë‹¤ë©´, ì˜ˆì™¸ì²˜ë¦¬í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì— ì•Œë ¤ì¤€ë‹¤.  
(ì´í›„ ë¡œê·¸ì•„ì›ƒì„ í•˜ë“  ë‹¤ìŒ ì•¡ì…˜ì€ í´ë¼ì´ì–¸íŠ¸ìª½ì— ë§¡ê¸´ë‹¤.)

<br/>  

#### JWT Redis ì €ì¥, ì¬ë°œí–‰ ì½”ë“œ

ìœ„ì™€ ê°™ì€ í”Œë¡œìš°ë¡œ ì¼ë‹¨ ì •ë¦¬ë¥¼ í•˜ì˜€ë‹¤.   
í•´ë‹¹ ë¡œì§ êµ¬í˜„ì€ ì•„ë˜ì—ì„œ ì‚´í´ë³´ì.  
ëª¨ë“  ë¡œì§ì„ ì ì–´ë‘ì§„ ì•Šì„ ê²ƒì´ê³ , ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ”  
ë¶€ë¶„ì˜ í´ë˜ìŠ¤ ë‚´ìš©ë“¤ë§Œ ì ì–´ë³¼ ì˜ˆì •ì´ë‹¤.   

**1). ë¡œê·¸ì¸ì‹œ JWT í† í° ë°œê¸‰, Redisì— ì €ì¥**  

**JwtAuthenticationFilter í´ë˜ìŠ¤**  

```java
public class JwtAuthenticationFilter extends UsernamePasswordAuthenticationFilter {
    private final AuthenticationManager authenticationManager;
    private final TokenProvider tokenProvider;
    private final RedisDao redisDao;

    public JwtAuthenticationFilter(AuthenticationManager authenticationManager, TokenProvider tokenProvider, RedisDao redisDao) {
        this.authenticationManager = authenticationManager;
        this.tokenProvider = tokenProvider;
        this.redisDao = redisDao;
    }
    
    @SneakyThrows
    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) {
        ObjectMapper objectMapper = new ObjectMapper();

        LoginDto loginDto = objectMapper.readValue(request.getInputStream(), LoginDto.class); // ServletInputSteamì„ LoginDto í´ë˜ìŠ¤ ê°ì²´ë¡œ ì—­ì§ë ¬í™” (ì¦‰, JSON ê°ì²´êº¼ëƒ„)
        log.info("# attemptAuthentication : loginDto.getEmail={}, login.getPassword={}",loginDto.getEmail(),loginDto.getPassword());

        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginDto.getEmail(), loginDto.getPassword());
        return authenticationManager.authenticate(authenticationToken);
    }

    @Override
    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult) throws ServletException, IOException {

        AuthMember authMember = (AuthMember) authResult.getPrincipal();
        TokenDto tokenDto = tokenProvider.generateTokenDto(authMember);
        String accessToken = tokenDto.getAccessToken(); // accessToken ë§Œë“¤ê¸°
        String refreshToken = tokenDto.getRefreshToken(); // refreshToken ë§Œë“¤ê¸°

        tokenProvider.accessTokenSetHeader(accessToken,response); // AccessToken Header response ìƒì„±
        //tokenProvider.refreshTokenSetHeader(refreshToken,response); // RefreshToken Header response ìƒì„±
        tokenProvider.refreshTokenSetCookie(refreshToken,response); // RefreshToken Cookieë¡œ ì„¤ì •
        Responder.loginSuccessResponse(response,authMember); // login ì™„ë£Œì‹œ Response ì‘ë‹µ ë§Œë“¤ê¸°

        // ë¡œê·¸ì¸ ì„±ê³µì‹œ Refresh Token Redis ì €ì¥ ( key = Refresh Token / value = Access Token )
        int refreshTokenExpirationMinutes = tokenProvider.getRefreshTokenExpirationMinutes();
        redisDao.setValues(refreshToken,accessToken, Duration.ofMinutes(refreshTokenExpirationMinutes));

        this.getSuccessHandler().onAuthenticationSuccess(request,response,authResult);
    }
}
```
`UsernamePasswordAuthenticationFilter`ë¥¼ ìƒì†ë°›ì•„  
êµ¬í˜„í•œ `JwtAuthenticationFilter` í•„í„° í´ë˜ìŠ¤ì´ë‹¤. Spring Securityì—  
FilterChainì— ì„¤ì •í•´ë‘ì–´ ë¡œê·¸ì¸ ìš”ì²­ì‹œ í•´ë‹¹ í•„í„°ë¥¼ ê±°ì¹˜ê²Œëœë‹¤.   

ì—¬ê¸°ì„œ ì¤‘ì ì ìœ¼ë¡œ ë´ì•¼í•  ì½”ë“œëŠ”  
`successfulAuthentication`ë©”ì„œë“œ ë¶€ë¶„ì´ë‹¤.  
`UsernamePasswordAuthenticationFilter` í•„í„°ì—ì„œëŠ”   
ì¸ì¦ëœ ê°ì²´ë¥¼ `Security Context Holder`ì— ì €ì¥í•´ì£¼ëŠ” ì—­í• ì„í•œë‹¤.  

ë‚˜ì™€ ê°™ì€ ê²½ìš°ëŠ” í•´ë‹¹ í•„í„°ë¥¼ Overrideí•˜ì˜€ê¸° ë•Œë¬¸ì—  
`Security Context Holder`ì— ê°ì²´ì €ì¥í•˜ëŠ”ê±´ `JwtVerificationFilter`ë¼ëŠ”  
ì¸ì¦í•„í„°ë¥¼ ë§Œë“¤ì–´ ì²˜ë¦¬í•´ì£¼ì—ˆê³ , í˜„ì¬ ìœ„ì— ì˜¬ë ¤ë‘” í•„í„°í´ë˜ìŠ¤ì—ì„œëŠ”  
JWT ë°œí–‰ê³¼ `redisDao.setValues()`ë©”ì„œë“œë¥¼ í†µí•´ Redisì—   

```text
Key : refreshToken  
Value : accessToken  
ì†Œë©¸ì‹œê°„ : 2ì¼
```
ë¡œ ì €ì¥ì„ í•´ì£¼ê²Œ ë˜ì—ˆë‹¤. ìœ„ í”Œë¡œìš°ì—ì„œ ì–˜ê¸°í–ˆë˜ 1),2)ë²ˆì— í•´ë‹¹í•˜ëŠ” ë‚´ìš©ì´ë‹¤.  
ì´ë ‡ê²Œ í•„í„° êµ¬í˜„ ë¶€ë¶„ì—ì„œ JWTë¥¼ ë°œí–‰í•´ Redisì— ì €ì¥í•´ì£¼ê²Œ ë˜ì—ˆë‹¤.  

<br/>

**2). Token ë§Œë£Œì‹œ JWT ì¬ë°œí–‰**  

ìœ„ì—ì„œ ë¡œê·¸ì¸ì‹œ í† í° ë°œê¸‰ê¹Œì§€ í•´ì£¼ì—ˆê³     
í´ë¼ì´ì–¸íŠ¸ì—ì„œ Access Tokenì„ í—¤ë”ì— ë‹´ì•„ ì–´ë–¤  
APIë¥¼ ìš”ì²­í•˜ì˜€ì„ë•Œ, í† í°ì´ ë§Œë£Œë˜ì—ˆë‹¤ê³  ì„œë²„ì—ì„œ í™•ì¸í•´ì„œ ì•Œë ¤ì£¼ë©´  
ì¬ë°œí–‰ APIë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚´ê¸°ë¡œ í–ˆì—ˆë‹¤.   


â—ï¸ Access Token ë§Œë£Œí™•ì¸ ì½”ë“œëŠ” ë„ˆë¬´ ë§ê¸°ë•Œë¬¸ì— ìƒëµí•©ë‹ˆë‹¤.  
í•„ìëŠ” `JwtAuthenticationFilter` í•„í„°í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ `OncePerRequestFilter`ë¥¼  
ìƒì†ë°›ì•„ APIìš”ì²­ì‹œ `doFilterInternal`ë¥¼ Overrideë°›ì•„ êµ¬í˜„í•´ í•´ë‹¹ í•„í„°ì—ì„œ   
JWT í•´ë…ì„í•˜ê³ , ì •ìƒì ìœ¼ë¡œ í•´ë…í•˜ë©´ APIê°€ ì‹¤í–‰ë  ê²ƒì´ê³ , í† í°ì— ë¬¸ì œê°€ ìˆê±°ë‚˜ ë§Œë£Œê°€ë˜ì—ˆìœ¼ë©´  
ì˜ˆì™¸ì²˜ë¦¬í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì— JSONì„ ë§Œë“¤ì–´ Bodyì— ë˜ì ¸ì£¼ì—ˆìŠµë‹ˆë‹¤.  

<br/>

**MemberController í´ë˜ìŠ¤**

```java
@Slf4j
@RestController
@Validated
@RequiredArgsConstructor
@RequestMapping("/members")
public class MemberController {

    private final MemberService memberService;

    ...

    @GetMapping("/reissue")
    public ResponseEntity reissue(@CookieValue(value = "refreshToken", required = false) String refreshToken,
                                  HttpServletRequest request,
                                  HttpServletResponse response){

        memberService.reissueAccessToken(refreshToken,request,response);
        return new ResponseEntity("Refresh Token ì¬ë°œê¸‰ ì™„ë£Œ!",HttpStatus.CREATED);
    }
}
```
ì¬ë°œí–‰ì„ ì‹¤í–‰í•´ì£¼ëŠ” APIì´ë‹¤. í•´ë‹¹ APIëŠ”  
ìœ„ì—ì„œ ì–˜ê¸°í–ˆë˜ `JwtAuthenticationFilter`ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šê²Œ  
`shouldNotFilter`ë¥¼ êµ¬í˜„í•´ ì²˜ë¦¬í•´ì¤„ ìˆ˜ ìˆë‹¤.   
ê·¸ë ‡ê²Œë˜ë©´ AccessTokenì´ ë§Œë£Œë˜ì—ˆë”ë¼ë„, í•´ë‹¹ APIëŠ” ì‹¤í–‰ì´ ëœë‹¤.  
í•´ë‹¹ ë¡œì§ì€ API ìš”ì²­ë¶€ë¶„ì´ê³ , ì´ì œ ì¤‘ìš”í•œ Serviceë¡œì§ì„ í™•ì¸í•´ë³´ì  

<br/>

**MemberSerivce í´ë˜ìŠ¤**  
```java
@Service
@Slf4j
@RequiredArgsConstructor
@Transactional
public class MemberService {
    private final MemberRepository memberRepository;
    private final CustomBeanUtils<Member> beanUtils;
    private final PasswordEncoder passwordEncoder;
    private final CustomAuthorityUtils authorityUtils;
    private final TokenProvider tokenProvider;
    private final RedisDao redisDao;

    ...

    public void reissueAccessToken(String refreshToken, HttpServletRequest request, HttpServletResponse response){

        if(refreshToken == null){
            throw new BusinessLogicException(ExceptionCode.COOKIE_REFRESH_TOKEN_NOT_FOUND);
        }

        String accessToken = tokenProvider.resolveToken(request);
        String redisAccessToken = redisDao.getValues(refreshToken);

        // Refresh Tokenì´ Redisì— ì¡´ì¬í•  ê²½ìš° Access Token ìƒì„±
        if(redisDao.validateValue(redisAccessToken) && accessToken.equals(redisAccessToken)){
            log.info("# RefreshTokenì„ í†µí•œ AccessToken ì¬ë°œê¸‰ ì‹œì‘");
            Claims claims = tokenProvider.parseClaims(refreshToken); // Refresh Token ë³µí˜¸í™”
            String email = claims.get("sub", String.class); // Refresh Tokenì—ì„œ emailì •ë³´ ê°€ì ¸ì˜¤ê¸°
            Member member = findVerifiedMember(email); // DBì—ì„œ ì‚¬ìš©ì ì •ë³´ ì°¾ê¸°
            AuthMember authMember = AuthMember.of(member.getId(), member.getEmail(), member.getRoles());
            TokenDto tokenDto = tokenProvider.generateTokenDto(authMember); // Token ë§Œë“¤ê¸°
            int refreshTokenExpirationMinutes = tokenProvider.getRefreshTokenExpirationMinutes();
            redisDao.setValues(refreshToken, tokenDto.getAccessToken(), Duration.ofMinutes(refreshTokenExpirationMinutes));
            tokenProvider.accessTokenSetHeader(tokenDto.getAccessToken(),response);

        } else if(!redisDao.validateValue(redisAccessToken)){
            throw new BusinessLogicException(ExceptionCode.REFRESH_TOKEN_NOT_FOUND);
        } else {
            throw new BusinessLogicException(ExceptionCode.TOKEN_IS_NOT_SAME);
        }
    }
}
```

ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë¡œì§ë“¤ì€ ì§€ìš°ê³  í‘œí˜„í•´ë‘ì—ˆë‹¤.   
`reissueAccessToken`ë©”ì„œë“œë¼ëŠ” ë¶€ë¶„ì„ ë§Œë“¤ì–´ ê²€ì¦ ë¡œì§ì„ ì‘ì„±í–ˆë‹¤.  

ì²«ë²ˆì§¸ë¡œëŠ” ì¿ í‚¤ì— RefreshTokenì´ ì œëŒ€ë¡œ ë‹´ê²¨ì™”ëŠ”ì§€ë¥¼ í™•ì¸í•œë‹¤.  

ê·¸ë¦¬ê³ ëŠ” ì´ì œ í—¤ë”ì— ë‹´ê¸´ AccessTokenì„ êº¼ë‚´ê³   
ì¿ í‚¤ë¡œ ì „ë‹¬ë°›ì€ RefreshTokenìœ¼ë¡œ `redisDao.getValues`ë©”ì„œë“œë¥¼ ì´ìš©í•´  
Redisì—ì„œ AccessTokenì„ êº¼ë‚¸ë‹¤. _**(key=refreshToken, value=accessTokenìœ¼ë¡œ ì €ì¥í–ˆìœ¼ë‹ˆê¹Œ!)**_  

ì´ì œ `if(redisDao.validateValue(redisAccessToken) && accessToken.equals(redisAccessToken))`  
ë¹„êµë¬¸ì„ í†µí•´ ì´ ë‘ê°œì˜ AccessTokenì„ ë¹„êµí•´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ê³   
ë§Œì•½ êº¼ë‚´ì™”ì„ë•Œ ì†Œë©¸ì´ ëœ ìƒíƒœë¼ë©´ `redisDao.validateValue(redisAccessToken)`ì—  
nullê°’ì´ ì°í˜€ìˆê²Œë˜ì–´ ë‘˜ ì¤‘í•˜ë‚˜ë¼ë„ ì¡°ê±´ì´ ë§Œì¡±í•˜ì§€ ëª»í•˜ë©´ ì˜ˆì™¸ì²˜ë¦¬ê°€ ë  ê²ƒì´ë‹¤.  

ì¦‰! Refresh Tokenì´ ì¡´ì¬í•˜ê³ (ì†Œë©¸ë˜ì§€ ì•Šê³ )  
í•´ë‹¹ Refresh Tokenì— ë§¤ì¹­ë˜ëŠ” Access Tokenì„ ë“¤ê³ ì™”ì„ë•Œë§Œ  
Access Tokenì„ ì¬ë°œí–‰ í•œë‹¤ìŒì— ë‹¤ì‹œ í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡í•´ì¤€ë‹¤ëŠ” ì„œë¹„ìŠ¤ ë¡œì§ì´ë‹¤.  

<br/>  

### ğŸ“Œ ì •ë¦¬  

ì´ë ‡ê²Œ ì—¬ëŸ¬ê°€ì§€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¾ì•„ë³´ë©´ì„œ   
ìš°ì„  ë‚´ê°€ ìƒê°í•˜ëŠ”ëŒ€ë¡œ ì •ë¦¬í•˜ì—¬ ì˜¬ë ¤ë³´ì•˜ë‹¤.   
ì´ ë°©ë²•ì´ í‹€ë¦´ìˆ˜ë„ ìˆê³ , ì–´ëŠì •ë„ íƒ€í˜‘ì´ ë  ìˆ˜ë„ ìˆë‹¤ê³  ìƒê°í•œë‹¤.   

ì•ìœ¼ë¡œë„ í† í°ì„ ì‚¬ìš©í•œë‹¤ë©´ ë³´ì•ˆì— ëŒ€í•´ ì¢€ë” ê¹Šê²Œ ê³µë¶€ë¥¼ í•´ë´ì•¼í•  ê²ƒ ê°™ë‹¤.  
ë˜í•œ, ì´ ê¸€ì˜ ë³¸ëª©ì ì€ ì½”ë“œë¥¼ ì „ë¶€ ë¦¬ë·°í•œë‹¤ê¸° ë³´ë‹¤ëŠ”  

ì–´ë– í•œ íë¦„ìœ¼ë¡œ ì‘ì—…ì„ í–ˆëŠ”ì§€ì™€ Redisë¥¼ ì´ìš©í•˜ì—¬  
í† í°ì„ ë¹„êµí•˜ëŠ” ë¶€ë¶„ì— ì´ˆì ì„ ë‘ê³  ì‘ì„±í–ˆê¸°ì—   
Spring Securityì— ëŒ€í•œ ë‚´ìš©ì„ ì–´ëŠì •ë„ ì„ ìˆ˜ì§€ì‹ìœ¼ë¡œ ê°€ì§€ê³  ìˆì–´ì•¼í•˜ê¸°ì—  
ì¡°ê¸ˆ ë¶ˆì¹œì ˆí•œ ì„¤ëª…ì´ ë  ìˆ˜ë„ ìˆì„ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ë“ ë‹¤.  

ê·¸ë˜ë„ ì°¸ê³ ì°¨ ì˜¬ë ¤ë³´ê³   
ë‚´ê³µë¶€ë¥¼ ìœ„í•œ ê¸°ë¡ì´ê¸°ë„í•˜ì—¬ ì •ë¦¬í•´ë³´ì•˜ë‹¤ ğŸ“š



<br/>
<br/>
<br/>


âœ¨ ì°¸ê³  ë¸”ë¡œê·¸
[Redis Jpa ì‚¬ìš© ë ˆí¼ëŸ°ìŠ¤], [Redis ì‚¬ìš©ë°©ë²• 2ê°€ì§€ ë ˆí¼ëŸ°ìŠ¤]

<br/>
<br/>

[Redis ì„¤ì¹˜ ë° CLI ì‚¬ìš©ë²•]: https://mycatlikeschuru.github.io/db/2023/01/08/db-redissetting.html
[Redis Jpa ì‚¬ìš© ë ˆí¼ëŸ°ìŠ¤]: https://hudi.blog/refresh-token-in-spring-boot-with-redis/
[Redis ì‚¬ìš©ë°©ë²• 2ê°€ì§€ ë ˆí¼ëŸ°ìŠ¤]: https://wildeveloperetrain.tistory.com/32