---
layout: post
title: TIL) Spring Security JWT 사용하여 인증하기
subtitle: 코드스테이츠 백엔드 부트캠프 D+97
categories: TIL
tags: [TIL, 부트캠프, 코드스테이츠]
comments: true
published: false
---

날씨가 많이 쌀쌀해졌다.  

![image](https://lh3.googleusercontent.com/u/0/drive-viewer/AFDK6gOtphG8edbKbbvSASKsJ_-tJ0REdmM2lcBp23tquh_bZGuSnGZt9pJIqpz7InTIiLhjrD7ZaBJzmsPBW69wtFDH28VC=w3024-h1728){: .align-left style="max-width: 60%"}

요즘 학습량이 늘어나 새벽까지 공부하다보니  
컨디션 난조가 심하다.. 일찍자려고해도  
어떻게 하다보니까 해야할 것들이 밀려 늦게 잠을 청하게된다.   

그러다보니 아침,점심에 정신을 못차리고 공부를 제대로 못하는..  
악순환의 반복이다. 오늘은 최대한 일찍 공부를 마치고  
월드컵도 시작이니 일찍 잠을 자야겠다.

---

어제 [JWT 인증] 파트에서 JWT에 대해 기초지식을  
공부했었고, 실제로 AcessToken, RefreshToken을 만들어보기도 했다.  

이제 JWT 토큰을 만드는 방법을 알았으니  
이 토큰을 어떻게 Headers로 전송하고  
Spring Security를 이용해 인증과정을 거치게 되는지? 에 대한  
내용을 오늘 공부해보려 한다.  

## JWT를 이용한 Spring Security 인증  

### 어떻게 인증을하지?

우선 [Spring Security 인증처리]에 대한  
선수지식을 가지고 있어야 해당 내용을 이해할 수 있다.  

JWT를 사용하여 인증을 진행하려면  
기존에 인증처리에서 사용하는 `UsernamePasswordAuthenticationFilter`를  
비활성화로 변경한 후에 상속받아 클래스를 구현해 인증을 처리해줄 수 있다.  
(구현하는건 이제부터 개발자가 해야하는 영역)   

![image](https://lh3.googleusercontent.com/u/0/drive-viewer/AFDK6gOQR4FMzSp9LHOptJF9_XBX4UQULmx47cZIefY8NeWpgeh2vTm3_WS04sbLy7xWlLrtlt4FbZfxdTdk501lzUyEOSykZQ=w1299-h921){: .align-left style="max-width: 100%"}



### JWT 예외관련

정상적인 JWT를 하나 만들었다.

![image](https://lh3.googleusercontent.com/u/0/drive-viewer/AFDK6gM7CWzAFQjn80N1hvvM9SUK3D93K7v6MKWNbJ73maG_WsDGVAWRlzCA7i2-X3BqaLP0fLkeuY3__aTBsAL3k4TzG2hqqQ=w3024-h1728){: .align-left style="max-width: 100%"}

해당 JWT를 가지고 값을 변경해보면서  
예외가 발생하는지 테스트를 해보았다.

<br/>

**1). ExpiredJwtException 예외**   

JWT를 생성할 때 지정한 유효기간이 초과할때 발생하는 예외다

```
io.jsonwebtoken.ExpiredJwtException: JWT expired at 2022-11-24T07:28:32Z. Current time: 2022-11-24T07:31:05Z, a difference of 153263 milliseconds.  Allowed clock skew: 0 milliseconds.
```

로그인 요청을 할때, 우리는 JWT 토큰을 Header에 담아서 보내준다.  
토큰을 만들때는 만료시간을 설정하는데  
설정한 만료시간이 지났는데 리소스에 접근요청을 보내면  
해당 예외가 발생한다.

<br/>

**2). MalformedJwtException 예외**   

JWT가 올바르게 구성되지 않았을때 발생하는 예외이다.
```
io.jsonwebtoken.MalformedJwtException: Malformed JWT JSON: 
```
실제로 구성을 바꿨을때 예외가 발생했다.  

![image](https://lh3.googleusercontent.com/u/0/drive-viewer/AFDK6gPQhIjSnqeeREeIFdpD_a2vMw-E6r_7tu74DY46aqKGtvdcc9GP-PTkbfKyKeUIqpUJJpGuPmCFdHGTJ8wPGEh_A-FrXg=w3024-h1728){: .align-left style="max-width: 100%"}

위의 사진처럼 Header의 맨앞부분을 변경했더니  
디코딩이 되지 않아 형식을 확인할 수 없는 문제가 생겼다.  

실제로 JWT 홈페이지에서 사진처럼 디코딩을 해보면  
인코딩쪽에 형식이 맞지않아 빨간색으로 표시가 되는 것을 볼 수 있다.


<br/>

**3). SignatureException 예외**  

JWT의 기존 서명을 확인하지 못했을 때 생기는 예외이다.
```
io.jsonwebtoken.security.SignatureException: Unsupported signature algorithm 'H{256'
```
실제로 서명을 확인하지 못할경우 위와 같이  
Exception이 발생한다.  



![image](https://lh3.googleusercontent.com/u/0/drive-viewer/AFDK6gM-B56_cW6Bvc86vXPTHrYxah_eJccUX-5yCNznSlZds4Ad2wCQ5-06B79zGh14djTNIyyEsiGiZofmUGLsX4T-oiVj=w3024-h1728){: .align-left style="max-width: 100%"}

정상 JWT에서 Header 부분을 변경해 예외를 터트려보았다.  
형식이 깨지지 않는 선에서 서명이 확인되지 않으면  
발생하는 예외인 것 같다.

사진에서 볼 수 있는 것처럼 Header의 `'alg' : "H{256"`으로  
형식은 깨지지 않았으나, Header에 이상한 값이 들어가  
서명을 확인하지 못하는 경우가 발생한 것이다.

<br/>

[JWT 인증]: https://mycatlikeschuru.github.io/til/2022/11/23/til.html
[Spring Security 인증처리]: https://mycatlikeschuru.github.io/til/2022/11/21/til.html


---


<br/>  

<span style="color:#994C00">**오늘의 커피량**</span>: ☕️ ☕️ ☕️ ☕️  
**오늘의 점심**: 